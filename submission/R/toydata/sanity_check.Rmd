---
title: "Greedy heuristic sanity check"
author: "Anne Hartebrodt"
date: "October 8, 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=FALSE}
require(data.table)
require(gridExtra)
require(ggplot2)
require(cowplot)
require(viridis)
```

# Data and parameters
This is a test to see if the greedy heuristic works on simplisitic toydata. A variying numer of differently sized networks have been hidden in the data, we call these "foreground nodes". P-Values for the foreground nodes have been sampled from a normal distribution with mean close to 0 and a small standard deviation. P-values for the background nodes have been sampled from a normal distribution with mean=0.6 and small standard deviation, such that the overlap between the forground and background score distributions is not given.

The greedy heuristic has been performed using the known number of "forground" nodes as maximum network size. For data with more than one "forground" network the maximum network size has been set to a slightly higher number of nodes in order to allow the greedy heuristic to jump to the next network and find all good = forground nodes.

## Distribution of foreground and backgound p-values for all the datasets
```{r data_hist}
filelocation<-"/home/anne/Masterarbeit/simplistic/result_low/biogrid/"
goldstandard<-"/home/anne/Masterarbeit/simplistic/sample_data/biogrid/"
fdir<-"/home/anne/Masterarbeit/simplistic/"

dd<-dir(goldstandard)
dat<-data.frame()
for(pdir in dd){
  files<-grep("general", dir(file.path(goldstandard, pdir)), value = T)
for(f in files){
df<-fread(file.path(goldstandard, pdir, f))
df$file<-f
df$dir<-pdir
dat<-rbind(dat,df)
}
}
g0<-ggplot(dat, aes(x=V2, fill=file))+geom_histogram(position = "dodge", bins = 100)+ggtitle("Distribution of P-Values in Simplistic Toydata")+xlab("P-Value")+ylab("Count")+guides(fill=F)+facet_wrap("dir", nrow = 1)+
  theme(axis.text.x = element_text(angle = 90))
ggsave(file=file.path(fdir, "SimplisticToydata.pdf"), g0, width = 20, height = 7, units = "cm")
```
```{r, echo=F}
fdr <- data.frame(V1 = c(), V2 = c(), V3 = c(), V4=c())
dd<-dir(filelocation)
#dd<-grep("2453", dd, value = T)
for(pdir in dd){
for (d in dir(file.path(filelocation,pdir))) {
if(file.exists(file.path(filelocation, pdir, d, "teststats.txt"))){
fdr_temp <- fread(file.path(filelocation, pdir, d, "teststats.txt"))
}
  else{
    next
  }
fdr_temp$V3 <- d
fdr_temp$V4<-pdir
fdr <- rbind(fdr, fdr_temp)
}
}

```

```{r, echo=FALSE}
annotation_table<-data.table(unique(fdr$V4))
annotation_table<-annotation_table[,tstrsplit(V1, "_")]
annotation_table$orig<-unique(fdr$V4)
annotation_table$Perm_meth<-gsub("degreeawarenodeswap", "degreeaware", annotation_table$Perm_meth)
fdr<-merge(fdr, annotation_table, by.x = "V4", by.y= "orig")
```

```{r, echo=FALSE}
fdr$V3 <-sapply(fdr$V3, function(x)
gsub(".tsv", "", gsub("result_", "", x)))
fdr$V4<-gsub("degreeawarenodeswap", "", fdr$V4)
fdr$V4<-gsub("biogrid_normDegSum", "", fdr$V4)
fdr2<-fdr
g<-ggplot(data = fdr, aes(x = V1, y = V2, color = FDR)) + geom_line() + ggtitle("Score Thresholds for each network size") + xlab("Network size") + ylab("FDR threshold")#+facet_wrap(~Aggr_meth, scales = "free")
```

## Overlap of gold standard gene set with detected (solution) networks
In order to assess wether the found solution was close enough to the foreground "gold standard" solution previously hidden in the network, the jaccard index was calculated. A Jaccard index of 1 means, that only the genes in the foreground gene set where contained in the solution.

```{r, echo=FALSE}
# jaccard distance
jaccard <- function(g, f1) {
sub1 <- f1[V1 == g, 2:4]
sub1 <- sub1[order(sub1$V2)]
su <- unique(c(sub1$V2, sub1$V4))
intersect_1 <- length(which(su %in% gold$gene))
#print(intersect_1)
union_1 <- length(unique(c(su, gold$gene)))
# print(union_1)
jaccard <- intersect_1 / union_1
return(list(jaccard, union_1, intersect_1, g))
}

d <- dir(filelocation)
gold.files <- grep("expression", dir(goldstandard), value = T)

overall_jaccard <- list()
network_jaccard <-
data.frame(
jaccard_dists = c(),
union = c(),
intersection = c(),
graph = c(),
filename = c(),
run = c()
)

complete_graphs<-data.frame()

for(pdir in dir(filelocation)){
for (gf in dir(file.path(filelocation,pdir))) {
gold <-fread(paste0(goldstandard, pdir, "/", gsub("result", "expression_type", gf), ".tsv"))
gold <- gold[V2 == "differential"]
gold <- gold[, 1]
colnames(gold) <- c("gene")

d.file <- gsub("expression_type", "result", gf)
if(!file.exists(file.path(filelocation, pdir, d.file, "file.graph"))){
  next
}
f1 <- fread(file.path(filelocation, pdir, d.file, "file.graph"))
f1[, .N, by = V1]

cp<-f1
f1$file<-gf
f1$run<-pdir
complete_graphs<-rbind(complete_graphs,f1)

su <- unique(c(f1$V2, f1$V4))
intersect_1 <- length(which(su %in% gold$gene))
union_1 <- length(unique(c(su, gold$gene)))
index_j <- intersect_1 / union_1
overall_jaccard[[gf]] <- index_j

jaccard_dists <- sapply(unique(f1$V1), function(g) jaccard(g, f1))
jaccard_dists<-data.table(jaccard_dists =jaccard_dists[1,], union = jaccard_dists[2,], intersection=jaccard_dists[3,], graph=jaccard_dists[4,])
jaccard_dists$filename<-gf
jaccard_dists$run<-pdir
network_jaccard<-rbind(network_jaccard, jaccard_dists)
}
}

network_jaccard$jaccard_dists <-as.numeric(network_jaccard$jaccard_dists)
network_jaccard$union <- as.numeric(network_jaccard$union)
network_jaccard$intersection <-as.numeric(network_jaccard$intersection)

network_jaccard<-merge(network_jaccard, annotation_table, by.x="run", by.y="orig")

network_jaccard[, nr_networks:=sapply(network_jaccard$filename, function(x) length(gregexpr("_", x)[[1]])/2)]
```

Below, we see the distribution of the forground and background p-values, with variing degree of overlap and the corresponding performance of the greedy heuristic measured using the Jaccard index.

```{r}
network_jaccard$nr_networks<-as.factor(network_jaccard$nr_networks)
g1 <-ggplot(network_jaccard, aes(x=nr_networks,y = jaccard_dists, fill=nr_networks))  + 
  geom_violin()+
  geom_boxplot(width=.1, outlier.colour=NA)+ 
  guides(fill=F)+
  ggtitle("Jaccard Distances to Foreground Toydata Genes Sets") + 
  ylab("Jaccard distance") +
  theme(axis.text.x = element_text(angle = 90))+xlab("Number of Networks Hidden in the Data")+
  facet_wrap("run", nrow = 1)+
  scale_fill_viridis_d()
pp<-plot_grid(g0, g1, ncol = 1)
ggsave(file=file.path(fdir, "SimplisticToydataJaccards.pdf"), g1, width = 20, height = 7, units = "cm")
plot(pp)
``` 

```{r}
ggsave(plot=pp, filename=file.path(fdir, "figure.pdf"))
```

