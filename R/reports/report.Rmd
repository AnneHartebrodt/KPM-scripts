---
title: "Report Greedy approach"
output: html_document
params: 
  filelocation: none 
  goldstandard: none
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#yaml::yaml.load() 
```

```{r}
filelocation<-params$filelocation
filelocation<-"/home/anne/Documents/Master/MA/distribution/result_true/biogrid/biogrid_sum_0.01_25_8998_degreeawarenodeswap_median_20_250/result_96_57_53_c////"
#filelocation<-"/home/anne/Masterarbeit/Testing/greedy100510/"
goldstandard<-params$goldstandard
  goldstandard<-"/home/anne/Masterarbeit/distribution/sample_data/biogrid/expression_type_96_57_53.tsv"
```


```{r, echo = F}
require(data.table)
require(ggplot2)
require(gridExtra)
require(viridis)
require(cowplot)
```



# FDR Threshold
Threshold has been determined selecting the p-value which includes at most 5% of the random networks for each network size. Random networks are created sampling 1000 networks for each n, p-values are determined using Fisher's method. Some values have been interpolated using a 
```{r}
fdr<-fread(file.path(filelocation, "teststats.txt"))
fdr$V1<-1:nrow(fdr)
thresh<-ggplot(data=fdr, aes(x = V1, y=V2))+geom_line( color="red")+ggtitle("FDR Thresholds vs. Network Size")+xlab("Network Size")+ylab("Score Threshold (FDR=0.05)")+ scale_color_manual(values=c( "#0064bc"), guide=F)
plot(thresh)
```
```{r}
ggsave(file.path(filelocation,"score_threshold.pdf"), thresh)
```

# How does the evolution of the scores of the growing subnetwork compare to the subnetwork of the same size?

To assess this, we calculate the difference of the score of the subnetwork and the threshold and plot the difference.

```{r}
if(file.exists(file.path(filelocation, "file.tracker"))){
evol<-fread(file.path(filelocation, "file.tracker"))
evol$V1<-as.character(evol$V1)
thres<-fread(file.path(filelocation, "teststats.txt"))
m<-merge(evol, thres, by.x = "V2", by.y="V1")
m$fdiff<-m$V2.y-m$V3

ggplot(m, aes(x=V2, y=fdiff, color=V1))+geom_line()+guides(color=FALSE)+ggtitle("Difference of subscore of candidate networks and thresholds")+xlab("Network size")+ylab("Difference")
}
```

Threshold are in the order of 10² while differnces are in the order of 10⁻¹, this means the difference is in the order of two bad p-values of 0.1-1.0. This must be a random effect. Hence choosing the maximum difference of the growing subnetwork score and the threshold of the respective size is not applicable.

# Comparison with gold standard -- Jaccard distance
Jaccard_dist(S1, S2) = intersect(S1,S2)/union(S1,S2)

```{r}
gold<-fread(goldstandard)
gold<-gold[V2=="differential"]
gold<-gold[,1]

colnames(gold)<-c("gene")

f1 <-fread(file.path(filelocation,"file.graph"))
f1[,.N, by = V1]

#f1<-f1[V1 %in% g]

jaccard<-function(g){
  sub1<-f1[V1==g,2:4] 
  sub1<-sub1[order(sub1$V2)]
  su<-unique(c(sub1$V2, sub1$V4))
  intersect_1<-length(which(su %in% gold$gene))
  #print(intersect_1)
  union_1<-length(unique(c(su, gold$gene)))
 # print(union_1)
  jaccard<-intersect_1/union_1
  return(c(jaccard, union_1, intersect_1))
}

  su<-unique(c(f1$V2, f1$V4))
  intersect_1<-length(which(su %in% gold$gene))
  union_1<-length(unique(c(su, gold$gene)))
  index_j<-intersect_1/union_1

jaccard_dists<-sapply(unique(f1$V1), function(g) jaccard(g))
jaccard_dists<-as.data.table(jaccard_dists)
jaccard_dists<-as.data.table(t(jaccard_dists))
colnames(jaccard_dists)<-c("jaccard_dists", "union", "intersection")
jaccard_dists$graph<-unique(f1$V1)

g1<-ggplot(jaccard_dists, aes(y=jaccard_dists, x="jaccard_dists"))+geom_boxplot()+ggtitle("Jaccard distances to 'gold standard' toydata genes")+ylab("Jaccard distance")
plot(g1)
g2<-ggplot(jaccard_dists, aes(y=union, x="jaccard_dists"))+geom_boxplot()+ggtitle("Union gene set")+ylab("")

g3<-ggplot(jaccard_dists, aes(y=intersection, x="jaccard_dists"))+geom_boxplot()+ggtitle("Intersect gene set")+ylab("")
grid.arrange(g1,g2,g3, ncol=3)
#plot(g1)
```






```{r}
pval<-fread(file.path(filelocation,"file.stat"))
pval[which.max(jaccard_dists$jaccard_dists)]
minp<-pval[which.min(V3)]$V1
jaccard(minp)
```


# P-value distribution of result networks
```{r}
nodes<-fread(file.path(filelocation,"file.nodes"))
gg<-nodes[, .N, by=V2]
```

```{r}
myframe<-merge(pval, gg, by.x = "V1", by.y="V2")
myframe<-merge(myframe, jaccard_dists, by.x = "V1", by.y="graph")
myframe[,norm:=V3/N]
myframe[order(norm, decreasing = F)]

```
```{r}
v1<-ggplot(myframe, aes(x=N, y=V3, color=jaccard_dists))+geom_point()+scale_fill_continuous(aesthetics = "fill")+theme(legend.position = "bottom", legend.text = element_text(angle = 90), legend.text.align = 1)
v2<-ggplot(myframe, aes(x=N, y=norm, color=jaccard_dists))+geom_point()+scale_fill_continuous(aesthetics = "fill")+theme(legend.position = "bottom", legend.text = element_text(angle = 90), legend.text.align = 1)
plot_grid(v1,v2, ncol=2)
```



